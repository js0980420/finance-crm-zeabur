name: Finance CICD

on:
  push:
    branches: [ master, develop ]

jobs:
  deploy:
    name: éƒ¨ç½²æ‡‰ç”¨ç¨‹å¼
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/master' && 'production' || 'development' }}
    
    steps:
      - name: å–å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p 8022 -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          echo "é–‹å§‹é€£æ¥åˆ°éƒ¨ç½²ä¸»æ©Ÿ..."
          
          ssh -p 8022 -i ~/.ssh/id_ed25519 -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
            set -e  # åœ¨ä»»ä½•å‘½ä»¤å¤±æ•—æ™‚ç«‹å³é€€å‡º
            
            BRANCH_NAME="${BRANCH_NAME}"
            
            echo "========================================="
            echo "é–‹å§‹éƒ¨ç½²ç¨‹åº..."
            echo "ç•¶å‰åˆ†æ”¯: \$BRANCH_NAME"
            echo "========================================="
            
            # ä¸»æ©Ÿé©—è­‰è³‡è¨Š (é˜²æ­¢GitHub Actionsé®ç½©)
            echo "ğŸ” ä¸»æ©Ÿé©—è­‰è³‡è¨Š:"
            
            # ä½¿ç”¨è®Šæ•¸é¿å…ç›´æ¥è¼¸å‡ºå¯èƒ½è¢«é®ç½©çš„å…§å®¹
            HOSTNAME_INFO=\$(hostname)
            IP_INFO=\$(hostname -I | awk '{print \$1}' 2>/dev/null || echo "IPç²å–å¤±æ•—")
            USER_INFO=\$(whoami)
            OS_INFO=\$(uname -s)
            DATE_INFO=\$(date '+%Y-%m-%d %H:%M:%S')
            PWD_INFO=\$(pwd)
            
            echo "ä¸»æ©Ÿåç¨±: [\$HOSTNAME_INFO]"
            echo "ä¸»æ©ŸIP: [\$IP_INFO]"  
            echo "ä½œæ¥­ç³»çµ±: \$OS_INFO"
            echo "ç•¶å‰ä½¿ç”¨è€…: \$USER_INFO"
            echo "ç•¶å‰æ™‚é–“: \$DATE_INFO"
            echo "ç•¶å‰ç›®éŒ„: \$PWD_INFO"
            echo "========================================="

            if [[ "\$BRANCH_NAME" == "master" ]]; then
              DEPLOY_PATH="project/bonus/finance"
            elif [[ "\$BRANCH_NAME" == "develop" ]]; then
              DEPLOY_PATH="project/bonus/develop/finance0810_D"
            else
              echo "No deploy path set for this branch: \$BRANCH_NAME"
              exit 1
            fi

            echo "ğŸ“ éƒ¨ç½²è·¯å¾‘é©—è­‰:"
            echo "ç›®æ¨™éƒ¨ç½²è·¯å¾‘: \$DEPLOY_PATH"
            
            # é©—è­‰éƒ¨ç½²ç›®éŒ„æ˜¯å¦å­˜åœ¨
            if [ ! -d "\$DEPLOY_PATH" ]; then
              echo "âŒ éŒ¯èª¤: éƒ¨ç½²ç›®éŒ„ä¸å­˜åœ¨ - \$DEPLOY_PATH"
              exit 1
            fi
            
            echo "âœ… éƒ¨ç½²ç›®éŒ„å­˜åœ¨"
            echo "åˆ‡æ›åˆ°éƒ¨ç½²ç›®éŒ„: \$DEPLOY_PATH"
            cd \$DEPLOY_PATH || { echo "âŒ ç„¡æ³•åˆ‡æ›åˆ°éƒ¨ç½²ç›®éŒ„"; exit 1; }
            
            # é©—è­‰Gitå€‰åº«
            if [ ! -d ".git" ]; then
              echo "âŒ éŒ¯èª¤: æ­¤ç›®éŒ„ä¸æ˜¯Gitå€‰åº«"
              exit 1
            fi
            
            echo "ğŸ“Š å€‰åº«è³‡è¨Š:"
            echo "Gitå€‰åº«URL: \$(git remote get-url origin)"
            echo "ç•¶å‰Gitåˆ†æ”¯: \$(git branch --show-current)"
            echo "æœ€å¾Œæäº¤: \$(git log -1 --oneline)"
            echo "========================================="
            
            # å‚™ä»½ç•¶å‰çš„ .env æª”æ¡ˆ
            if [ -f .env ]; then
              cp .env .env.backup
              echo "å·²å‚™ä»½ .env æª”æ¡ˆ"
            fi
            
            # æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼
            echo "æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼..."
            git pull || { echo "Git pull å¤±æ•—"; exit 1; }
            
            # å¦‚æœ .env è¢«è¦†è“‹ï¼Œå‰‡æ¢å¾©å‚™ä»½
            if [ -f .env.backup ]; then
              cp .env.backup .env
              rm .env.backup
              echo "å·²æ¢å¾© .env æª”æ¡ˆ"
            fi
                        
            # åƒ…é‡æ–°å»ºæ§‹ä¸¦å•Ÿå‹•å‰ç«¯æœå‹™
            docker compose up -d --build frontend
            
            # å¦‚æœå¾Œç«¯æœªé‹è¡Œï¼Œå‰‡å•Ÿå‹•å¾Œç«¯ï¼ˆä¸é‡æ–°å»ºæ§‹ï¼‰
            if [ "\$BACKEND_RUNNING" = "false" ]; then
              docker compose up -d backend mysql redis phpmyadmin
              echo "ç­‰å¾…å¾Œç«¯æœå‹™å•Ÿå‹•å®Œæˆ..."
              sleep 30
              
              # åŸ·è¡Œè³‡æ–™åº«é·ç§»ï¼ˆåƒ…åœ¨å¾Œç«¯é‡æ–°å•Ÿå‹•æ™‚ï¼‰
              docker compose exec -T backend php artisan migrate --force
              
              # åŸ·è¡Œè³‡æ–™åº«å¡«å……ï¼ˆå¦‚æœéœ€è¦ï¼‰
              docker compose exec -T backend php artisan db:seed --force --class=RolesAndPermissionsSeeder
            fi

            # æ¯æ¬¡éƒ½åŸ·è¡Œmigrate
            echo "åŸ·è¡Œmigrate"
            docker compose exec -T backend php artisan migrate --force
            
            # æ¸…é™¤å¿«å–ï¼ˆæ¯æ¬¡éƒ¨ç½²éƒ½åŸ·è¡Œï¼‰
            echo "ğŸ§¹ æ¸…é™¤æ‡‰ç”¨ç¨‹å¼å¿«å–..."
            docker compose exec -T backend php artisan config:cache
            docker compose exec -T backend php artisan route:cache
            docker compose exec -T backend php artisan view:cache
            
            # æœ€çµ‚éƒ¨ç½²é©—è­‰
            echo "========================================="
            echo "ğŸ¯ æœ€çµ‚éƒ¨ç½²é©—è­‰:"
            echo "========================================="
            
            # æª¢æŸ¥æ‰€æœ‰å®¹å™¨ç‹€æ…‹
            echo "ğŸ“Š æ‰€æœ‰å®¹å™¨ç‹€æ…‹:"
            docker compose ps
            echo ""
            
            # æª¢æŸ¥å®¹å™¨å¥åº·ç‹€æ…‹
            UNHEALTHY_CONTAINERS=\$(docker compose ps --filter "status=unhealthy" --format "table {{.Service}}")
            if [ -n "\$UNHEALTHY_CONTAINERS" ] && [ "\$UNHEALTHY_CONTAINERS" != "SERVICE" ]; then
              echo "âš ï¸  ç™¼ç¾ä¸å¥åº·çš„å®¹å™¨:"
              echo "\$UNHEALTHY_CONTAINERS"
            else
              echo "âœ… æ‰€æœ‰å®¹å™¨ç‹€æ…‹æ­£å¸¸"
            fi
            
            # é©—è­‰é—œéµæœå‹™æ˜¯å¦æ­£åœ¨é‹è¡Œ
            REQUIRED_SERVICES=("frontend" "backend" "mysql" "redis")
            for service in "\${REQUIRED_SERVICES[@]}"; do
              if [ "\$(docker compose ps -q \$service)" ]; then
                echo "âœ… \$service æœå‹™æ­£åœ¨é‹è¡Œ"
              else
                echo "âŒ \$service æœå‹™æœªé‹è¡Œ"
              fi
            done
            
            # é¡¯ç¤ºæœå‹™ç¶²è·¯è³‡è¨Š
            echo ""
            echo "ğŸŒ ç¶²è·¯è³‡è¨Š:"
            echo "å®¹å™¨ç¶²è·¯: \$(docker compose ps --format 'table {{.Service}}\t{{.Ports}}')"
            
            echo "========================================="
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
            echo "åˆ†æ”¯: \$BRANCH_NAME"
            echo "ä¸»æ©Ÿ: \$(hostname)"
            echo "éƒ¨ç½²è·¯å¾‘: \$DEPLOY_PATH"
            echo "å®Œæˆæ™‚é–“: \$(date)"
            echo "========================================="
          EOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519
